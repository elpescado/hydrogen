environment:
  matrix:
    # - MSYS: 'C:\msys64\mingw64'
    #   MSYS_REPO: 'mingw64/mingw-w64-x86_64'
    #   GENERATOR: "MinGW Makefiles"
    #   BUILD_TYPE: "Debug"
    #   CMAKE_FLAGS: "-DWANT_DEBUG:BOOL=ON -DWIN64:BOOL=ON"
    #   WDQ_MODE: "--debug"
    #
    - MSYS: 'C:\msys64\mingw64'
      MSYS_REPO: 'mingw64/mingw-w64-x86_64'
      GENERATOR: "MinGW Makefiles"
      BUILD_TYPE: "Release"
      CMAKE_FLAGS: "-DWANT_DEBUG:BOOL=OFF -DWIN64:BOOL=ON"
      WDQ_MODE: "--release"
    #   
    # - MSYS: 'C:\msys64\mingw32'
    #   MSYS_REPO: 'mingw32/mingw-w64-i686'
    #   GENERATOR: "MinGW Makefiles"
    #   BUILD_TYPE: "Debug"
    #   CMAKE_FLAGS: "-DWANT_DEBUG:BOOL=ON"
    #   WDQ_MODE: "--debug"

    - MSYS: 'C:\msys64\mingw32'
      MSYS_REPO: 'mingw32/mingw-w64-i686'
      GENERATOR: "MinGW Makefiles"
      BUILD_TYPE: "Release"
      CMAKE_FLAGS: "-DWANT_DEBUG:BOOL=OFF"
      WDQ_MODE: "--release"

    # - MINGW: 'C:\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\mingw64'
    #   MSYS: 'C:\msys64\mingw64'
    #   QTDIR: 'C:\Qt\5.13.2\mingw73_64'
    #   GENERATOR: "MinGW Makefiles"
    #   BUILD_TYPE: "Debug"
    #   MSYS_REPO: 'mingw64/mingw-w64-x86_64'
      
    # - MINGW: 'C:\mingw-w64\x86_64-7.3.0-posix-seh-rt_v5-rev0'
    #   QTDIR: 'C:\Qt\5.13.2\mingw73_64'
    #   GENERATOR: "MinGW Makefiles"
    #   BUILD_TYPE: "Release"
    #   MSYS_REPO: 'mingw64/mingw-w64-x86_64'

image:
  - "Visual Studio 2015"

before_build:
  cmd: |-
      echo %time%
      c:\msys64\usr\bin\pacman --noconfirm -S -q %MSYS_REPO%-libarchive
      c:\msys64\usr\bin\pacman --noconfirm -S -q %MSYS_REPO%-libsndfile
      c:\msys64\usr\bin\pacman --noconfirm -S -q %MSYS_REPO%-cppunit
      c:\msys64\usr\bin\pacman --noconfirm -S -q %MSYS_REPO%-portaudio
      c:\msys64\usr\bin\pacman --noconfirm -S -q %MSYS_REPO%-libwinpthread-git
      c:\msys64\usr\bin\pacman --noconfirm -S -q %MSYS_REPO%-qt5
      echo %time%

      set QTDIR=%MSYS%
      set CMAKE_PREFIX_PATH=%QTDIR%
      set PATH=%MSYS%\bin;%QTDIR%\bin;%PATH%
      set PKG_CONFIG_PATH=%MSYS%\lib\pkgconfig

      rename "C:\Program Files\Git\usr\bin\sh.exe" "sh2.exe"
      echo %PATH%
      rem mkdir build
      rem cd build
      cd windows
      cmake --version
      echo %time%
      cmake -G "%GENERATOR%" -DCMAKE_BUILD_TYPE=%BUILD_TYPE% %CMAKE_FLAGS% ..
      echo %time%

build:
  verbosity: detailed

build_script:
  - cmd: |-
      echo %NUMBER_OF_PROCESSORS%

      echo %time%
      cmake --build . -j %NUMBER_OF_PROCESSORS%
      echo %time%

      set H2_HOME=%APPVEYOR_BUILD_FOLDER%
      echo %H2_HOME%
      SET CORE_PATH=%cd%\src\core
      echo %CORE_PATH%
      set PATH=%CORE_PATH%;%PATH%
      file src\tests\tests.exe
      src\tests\tests.exe --appveyor || cmd /c "exit /b 0"
      7z a %APPVEYOR_BUILD_FOLDER%\testresults.zip %TEMP%\hydrogen
      appveyor PushArtifact %APPVEYOR_BUILD_FOLDER%\testresults.zip

      objdump -p "src\gui\hydrogen.exe" | grep "DLL Name"

      mkdir extralibs
      set PYTHON=C:\Python38\python
      %PYTHON% -m pip install -r %APPVEYOR_BUILD_FOLDER%\windows\requirements.txt
      echo %time%
      %PYTHON% %APPVEYOR_BUILD_FOLDER%\windows\copy_thirdparty_dlls.py -L %MSYS%\bin -d %APPVEYOR_BUILD_FOLDER%\windows\extralibs -V debug src/gui/hydrogen.exe src/core/libhydrogen-core-1.0.0.dll
      echo %time%
      %QTDIR%\bin\windeployqt.exe -xmlpatterns --dir extralibs %WDQ_MODE% src/gui/hydrogen.exe
      echo %time%

      echo %time%
      cpack -G NSIS -v
      echo %time%

      set INSTDIR=C:\prg
      mkdir %INSTDIR%
      FOR %%F IN (Hydrogen-*.exe) DO %%F /S /D=%INSTDIR%
      tree %INSTDIR%

      ls -l %INSTDIR%\hydrogen.exe
      strip %INSTDIR%\hydrogen.exe
      ls -l %INSTDIR%\hydrogen.exe

      %PYTHON% -m pytest %APPVEYOR_BUILD_FOLDER%\windows\test_installation.py --junitxml=test_installation.xml

      ls -l

on_finish:
  - cmd: |
      curl -F file=@%APPVEYOR_BUILD_FOLDER%\windows\test_installation.xml https://ci.appveyor.com/api/testresults/junit/%$APPVEYOR_JOB_ID%

artifacts:
  - path: windows\Hydrogen-*.exe
    name: Installer

# cache:
#   - C:\msys64\mingw32
#   - C:\msys64\mingw64

on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
